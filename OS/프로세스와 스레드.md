# 1. 프로세스의 개념과 상태 변화
## 프로세스(Process)
- 실행 중인 프로그램 <- `가장 일반적인 정의`
- 비동기적(Asynchronous) 행위
- 실행 중인 프로시저
- 실행 중인 프로시저의 제어 추적
- 운영 체제에 들어 있는 프로세스 제어 블록(PCB)
- 프로세서에 할당하여 실행할 수 있는 개체 디스패치(dispatch)가 가능한 대상


![프로세스의 구조](/OS//static//%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%20%EB%A9%94%EB%AA%A8%EB%A6%AC%20%EA%B5%AC%EC%A1%B0.jpg)

### 스택(Stack)
- 데이터를 일시적으로 저장하는 영역.
- **지역변수**에 사용. 변수가 범위 밖으로 이동할 때 공간을 해제.
- 함수를 호출할수록 커지고 반환할수록 줄어듦.

### 힙(Heap)
- 코드 영역과는 별도로 유지되는 **자유 영역**.
- 동적 메모리 할당과 프로그램 실행 중 시스템 호출 사용 및 해제 시 활용.
- 프로젝트 공유 라이브러리와 동적 적재 모듈이 서로 공유.

### 데이터(Data)
- 프로그램의 가상의 주소 공간.
- 전역변수, 정적 변수의 저장 및 할당에 사용.
- 실행 전 초기화되지만 실행 시간에 변경이 가능.
- 초기화하지 않은 데이터는 데이터 영역의 끝에 자리함.

### 코드(Code)
- 실행 명령을 포함하는 메모리 및 목적 파일에 있는 프로그램 영역.
- 프로그램을 시작할 대 프로세서가 디스크에서 읽어 실행되는 프로그램의 컴파일 본을 저장.

<br>
<br>

## 프로세스의 종류
1. 역할에 따른 종류

### 시스템(커널) 프로세스
- 모든 시스템 메모리 및 프로세스 명령에 액세스할 수 있는 프로세스.
- 프로세스 실행 순서 제어 및 다른 사용자 및 커널 영역을 침범하지 못하게 감시.
- 사용자 프로세스를 생성하는 역할을 담당.

### 사용자 프로세스
- 사용자 코드를 수행하는 프로세스.

---

2. 병행 수행 방법에 따른 종류

### 독립 프로세스
- 다른 프로세스에 영향을 주지 않거나 프로세스의 영향을 받지 않으면서 수행하는 병행 프로세스.

### 병행 프로세스
- 다른 프로세스에 영향을 주거나 다른 프로세스에서 영향을 받는 병행 프로세스.

<br>
<br>

## 프로세스의 상태 변화와 상태 정보
### 준비 -> 실행(`Dispatch`)
- 준비 큐 맨 앞에 있던 프로세스가 프로세서를 점유하는 과정.
- 실행 상태인 프로세스가 할당된 시간만큼만 프로세서를 사용하도록 해 특정 프로세스가 프로세서를 과독점하는 것을 방지.

### 실행 -> 준비(`TimeOut`)
- 인터럽트 클록을 통해 특정 프로세스가 할당된 시간 동안만 프로세서를 점유하게 함.
- 타임아웃 이후에도 프로세서를 반환하지 않을 시 클록이 인터럽트를 발생시켜 운영체제에 제어권 부여.


### 실행 -> 대기(보류)(`Block`)
- 할당된 시간 이전에 실행 상태의 프로세스에 입출력 연산 등이 필요할 때, 혹은 새 자원 요청 등의 문제로 프로세서를 스스로 양도한 상태.

### 대기(보류) -> 준비(`WakeUp`)
- 입출력 작업이 끝난 후의 상태.

<br>

## 프로세스 제어 블록
프로세스 제어 시 상태 정보와 관련한 내용은 **프로세스 제어 블록(PCB)**에 저장됨.

때문에 **작업 제어 블록(Task Control Block)**이라고도 함.

- 다음과 같은 정보가 저장되고 운영체제의 모든 모듈은 이 정보를 읽고 수정할 수 있음.

![프로세스 제어 블록](./static//%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%20%EC%A0%9C%EC%96%B4%20%EB%B8%94%EB%A1%9D.jpg)

## 프로세스 문맥 교환
: 인터럽트 및 시스템 호출 등으로 실행 중인 프로세스의 제어를 다른 프로세스에 넘겨 살행 상태가 되도록 하는 것. 레지스터에 있던 내용은 나중에 사용하도록 저장한다.

예시는 다음과 같다.

![프로세스 문맥 교환 예시](./static//%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%20%EB%AC%B8%EB%A7%A5%20%EA%B5%90%ED%99%98%20%EC%98%88%EC%8B%9C.jpg)

<br>
<br>

# 2. 프로세스의 관리


## 1. 프로세스의 구조
프로세스는 실행 중 프로세스 생성 시스템 호출을 통해 새 프로세스를 생성할 수 있다.

- **부모 프로세스**: 프로세스를 새로 실행하는 프로세스.
- **자식 프로세스**: 생성되는 프로세스. **서브 프로세스**라고도 함.

<br>

## 2. 프로세스의 생성
1. 운영체제, 응용 프로그램에서 요청을 받아 프로세스를 생성.
2. 운영체제가 해당 프로세스에서 프로세스 제어 블록(PCB)을 만들어 주소 공간 할당.
3. 프로세스 제어 블록 초기화(프로세스 상태, 프로그램 카운터 초기화 및 자원 요청, 프로세스 제어 정보 등 포함).
4. 링크를 걺(해당 큐에 삽입).

<br>

## 3. 프로세스의 종료
- **정상 종료**: 프로세스가 운영체제의 서비스를 호출할 때
- **시간 초과**: 프로세스가 명시된 전체 시간을 초과해 실행하거나 명시된 시간을 초과하면서 이벤트 발생을 기다릴 때
- **실패**: 파일 검색 실패, 입출력이 명시된 횟수를 초과해 실패할 때
- **etc**: 산술 오류, 보호 오류, 데이터 오류, 메모리 부족, 액세스 위반 등

<br>

## 4. 프로세스의 제거
- 프로세스 제거 시 사용 자원은 시스템에 반납하고 해당 프로세스의 PCB를 회수.
- 하지만 프로그램은 여전히 디스크에 저장.
- 자식 프로세스는 부모 프로세스를 제거하면 자동으로 제거됨.

<br>

## 5. 프로세스의 중단과 재시작
프로세스의 준비, 실행, 대기는 일반 연산보다 느려 대부분 유휴 상태인데, 이 문제를 해결하기 위해 프로세스 중단(일시정지) 상태를 도입하면 대기가 아닌 중단 상태가 되므로 이벤트가 발생 시 즉시 실행되게 바꿀 수 있다.

- **대기**: 자원을 할당받기 위해 기다리는 상태
- **중단**: 할당받은 자원을 기다리는 상태.

그 외에도 다음과 같은 상황에 사용한다.

- 시스템 장애 발생 시 기능 회복 재시작을 위하여
- 프로세스의 의심스러운 부분 확인 후 재시작 혹은 종료를 위하여
- 처리 작업 과다로 시스템에 부담이 갈 때 프로세스 조절을 위하여

<br>

## 프로세스의 우선순위 변경
- 프로세스 스케줄러가 PCB에 있는 우선순위를 이용해 준비 리스트의 프로세스 처리.
* 준비 리스트의 프로세스는 *프로세서 중심 프로세스*와 *입출력 중심 프로세스*로 구분.
    * **프로세서 중심 프로세스**: 속도가 느리면서 빠른 응답을 요구하는 단말기에 높은 우선순위 부여, 시간이 적게 할당됨. 
    * **입출력 중심 프로세스**: 속도가 빠르므로 낮은 우선순위를 부여. 시간이 많이 할당됨.

<br>

## 프로세스의 문맥 교환
현재 프로세스와 별도로 외부 이벤트 발생시 인터럽트가 발생. 이때, 인터럽트 처리 루틴으로 제어가 넘어간 후 유형에 따라 관련 루틴으로 분기.

- **입출력 인터럽트**: 입출력 동작 발생을 확인하고 이벤트를 기다리는 프로세스를 준비 상태로 바꾼 후 실행할 프로세스를 결정.
- **클록 인터럽트**: 현재 실행 중인 프로세스 할당 시간을 조사해 실행 중인 프로세스를 준비 상태로 변경한 후 다른 프로세스를 실행 상태로 변경.

인터럽트 발생 시 운영체제가 다른 프로세스를 실행 상태로 변경하고 제어를 넘겨 프로세스 문맥 교환이 발생. 그러나, 현재 프로세스를 재실행할 가능성이 있으므로 인터럽트가 프로그램 문맥 교환으로 발전하지는 않음.

- **문맥 교환(Context Switching)**: 이전 프로세스의 상태 레지스터 내용을 보관하고 다른 프로세스의 레지스터를 저장해 프로세스를 교환하는 과정. 대개 *준비 -> 실행* 시 혹은 *실행 -> 대기* 상태일 때 발생. 오버헤드가 발생하며, 가능하면 불필요한 문맥 교환을 줄일 수 있어야함.

# 3. 스레드의 개념과 상태 변화
## 스레드
: 프로세스의 특성 중 하나인 제어를 분리한 실행 단위.
- 프로세스 하나는 스레드 한 개 이상으로 나눌 수 있음.
- 스레드들은 프로세스의 직접 실행 정보 및 나머지 프로세스 관리 정보를 공유.
- 보통 다른 프로시저를 호출하고 다른 실행을 기록.
- 독립적인 프로그램 카운터로 같은 프로세스의 스레드들이 동시에 코드의 동일 부분/별도 부분을 실행할 수 있음.
- 관련 자원과 함게 메모리를 공유할 수 있는데, 손상된 데이터나 스레드의 이상 동작을 고려할 필요가 있음.
- **경량 프로세스**: 스레드 중에서 프로세스 속성 중 일부가 들어있는 것.
- **중량 프로세스**: 스레드 하나에 프로세스 하나인 전통적인 경우.

## 스레드의 이점
### 사용자 응답성 증가
응용 프로그램의 일부분을 봉쇄하거나 긴 작업을 수행하더라도 병렬 프로그래밍으로 프로그램을 계속 실행할 수 있어 사용자 응답성이 증가.

### 프로세스의 자원 및 메모리 공유 가능
스레드들이 프로세스 자원 하나와 메모리를 공유하므로 응용 프로그램 하나가 동일한 주소 공간에서 스레드를 여러 개 실행해 시스템 성능을 향상.

### 경제성의 이점
스레드 간의 컨텍스트 스위칭은 상대적으로 오버헤드가 적다.

### 다중 처리(멀티 프로세싱)로 성능과 효율 향상
각 스레드를 여러 프로세서에서 병렬로 실행하여 성능과 효율성을 높일 수 있다.

<br>

## 단일 스레드와 다중(멀티) 스레드
### 단일 프로세스와 단일 스레드
전통적인 방법. 스레드 용어가 생기기 전으로 개념은 불확실.

`ex)` 도스

---

### 다중 스레드
프로그램 하나를 여러 실행 단위로 쪼개어 실행한다는 측면에서 다중 처리(다중 프로세싱)와 유사한 개념.

동일 프로세스의 스레드는 자원을 공유해 자원 생성과 관리의 중복성을 최소화해 실행 능력을 향상.

`ex)` 현대 운영체제들...

<br>

## 스레드의 사용 예
- 운영체제의 많은 프로그램. ex) 워드 편집기 등
- 웹 브라우저
- 데이터베이스 시스템

<br>

## 스레드의 상태 변화
- 일반적으로 프로세스 생성 시 스레드도 함께 생성됨.
- 그러나 스레드 생성 시 부모 프로세스와 공유할 자원을 초기화할 필요가 없음. 그러므로 프로세스의 생성 및 종료보다는 오버헤드가 훨씬 적음.

<br>

## 스레드의 제어 블록
- 프로세스가 PCB에 저장하듯이 스레드도 스레드 제어 블록(**TCB**)에 정보를 저장한다.
- 프로세스는 스레드 한 개 이상을 가지므로 **PCB는 스레드 제어 블록의 리스트를 가리킨다**.

<br>

### TCB의 내용
- **실행 상태**: 프로세서 레지스터, 프로그램 카운터, 스택 포인터
- **스케줄링 정보**: 상태(실행, 준비, 대기), 우선순위, 프로세서 시간
- 계정 정보
- 스케줄링 큐용 다양한 포인터
- PCB를 포함하는 포인터

<br>
<br>

# 4. 스레드의 구현
스레드는 운영체제에 따라 다양한 구현이 가능하며, 대부분 세 가지 형태로 구현한다.

- **사용자 수준 스레드(User-level Thread)**: 다대일(n:1) 매핑. 스레드 라이브러리를 이용해 작동.
- **커널 수준 스레드(Kernel-level Thread)**: 일대일(1:1) 매핑. 커널(운영체제)에서 지원하는 형태.
- **혼합형 스레드(Multiplexed Thread)**: 다대다(n:m) 매핑. 사용자 수준 스레드와 커널 수준 스레드를 혼합한 형태.

<br>

## 사용자 수준 스레드
- 사용자 영역의 스레드 라이브러리로 구현.
- 스레드와 관련된 모든 행위를 사용자 영역에서 하므로 커널은 스레드의 존재를 모름.
- 스레드 라이브러리는 스레드의 생성 및 종료, 스레드 간의 메시지 전달, 스레드의 스케줄링 및 문맥 정보를 보관.
- 스레드 라이브러리는 `Pthread`, `Win32 스레드`, `자바 스레드 API` 등이 있음.
- 스레드 교환에 커널이 개입하지 않아 커널에서 사용자 영역으로 전환할 필요가 없음.
- 사용자 수준 스레드는 프로세스를 한 단위로 인식하고 프로세서를 할당함.
- **다수의 사용자 수준 스레드**가 **커널 수준 스레드 한 개**에 매핑됨(그래서 다대일 스레드 매핑이라고 함).

### 장점
- 커널에 독립적으로 스케줄링을 할 수 있어 모든 운영체제에 적용할 수 있어 **이식성이 높다**.
- 스케줄링이나 동기화를 위해 커널을 호출하지 않으므로 컨텍스트 스위칭의 **오버헤드가 줄어든다**.
- 커널이 아닌 스레드 라이브러리에서 스레드 스케줄링을 제어하므로 응용 프로그램에 맞게 **유연한 스케줄링이 가능**하다.

### 단점
- 스레드가 아닌 프로세스 단위로 프로세서를 할당해 다중 처리 환경을 갖춰도 스레드 단위로 다중 처리를 하지 못한다. 동일한 프로세스의 스레드 한 개가 대기 상태가 되면 어떤 스레드도 실행하지 못하는 **동시성을 지원하지 않는 문제**를 가지고 있다.
- 커널이 한 프로세스에 속한 여러 스레드에 프로세서를 동시 할당할 수 없어 다중 처리 시스템에서 **확장에 제약이 따른다**.
- **스레드 간 보호에 커널의 보호 방법을 사용할 수 없다**. 스레드 라이브러리에서 기능을 제공해야 프로세스 수준에서 보호가 가능하다.

<br>

## 커널 수준 스레드
- 사용자 수준 스레드의 한계를 극복하는 방법.
- 커널이 스레드와 관련된 모든 작업을 관리.
- 한 프로세스에서 다수의 스레드가 프로세서를 할당받아 병행으로 수행.
- 스레드 한 개가 대기 상태가 되면 동일한 프로세스에 속한 다른 스레드로 교환이 가능.
- 커널이 개입하므로 사용자 영역에서 커널 영역으로 컨텍스트 스위칭이 필요.
- 사용자 수준 스레드와 커널 수준 스레드가 1:1로 매핑됨. 즉, **사용자 수준 스레드 생성 시 이에 대응하는 커널 스레드를 자동 생성**.
- **윈도우 NT**,  **윈도우 XP**, **윈도우 2000**, **리눅스**, **솔라리스 9** 이상 버전의 운영체제들이 커널 수준 스레드를 구현.


### 장점
- 커널이 직접 스케줄링하고 실행해 사용자 수준 스레드의 커널 지원이 부족한 문제 해결 가능.
- 커널이 각 스레드를 개별적으로 관리해 동일한 프로세스의 스레드의 병행 수행이 가능.
- 동일 프로세스에 있는 스레드 중 하나만 대기 상태가 되어도 다른 스레드를 실행할 수 있음.


### 단점
- 커널이 전체 프로세스와 스레드 정보를 유지해 오버헤드가 커짐.

<br>

## 혼합형 스레드
- 사용자 수준 스레드와 커널 수준 스레드를 혼합한 구조.
- 시스템 호출을 할 때 다른 스레드를 중단하는 다대일(n:1) 매핑의 사용자 수준 스레드와 스레드 수를 제한하는 일대일 매핑의 커널 수준 스레드 문제를 극복하는 방법.
- 사용자 수준 스레드는 커널 수준 스레드와 유사한 경량 프로세스(LWP)에 다대다(n:m)로 매핑되고, 경량 프로세스는 커널 수준 스레드와 일대일(1:1)로 매핑됨.
- 스레드 라이브러리가 최적의 성능을 지원하도록 커널이 경량 프로세스의 수를 동적으로 조절해 다대다(n:m)로 매핑됨.

### 장점
- 자원과 입출력 대기를 위해 경량 프로세스 단위로 대기하므로 프로세스가 입출력 완료까지 대기할 필요가 없음. → 어떤 경량 프로세스가 입출력 완료를 기다리더라도 동일 프로세스에서 다른 경량 프로세스를 실행할 수 있기 때문.
- 스레드 라이브러리가 최적의 성능을 지원하도록 커널이 경량 프로세스 수를 동적으로 조절.- 스레드 풀링을 이용해 일대일(1:1) 매핑으로 오버헤드를 줄일 수 있음.

---

### 스레드 풀링(Thread Pooling)
시스템이 관리하는 스레드의 풀(Pool)을 응용 프로그램에 제공해 스레드를 효율적으로 사용할 수 있게 하는 방법.

즉, 미리 생성한 스레드를 재사용하도록 해 스레드를 생성하는 시간을 줄여 시스템에 부담을 줄임.

동시 생성 스레드 수 제한으로 시스템 자원 소비를 줄여 응용 프로그램의 전체 성능을 일정 수준으로 유지.

<br>
<br>

## 프로세스와 스레드로 보는 다중 처리
### 다중 처리(Multi Processing)
- 프로세서 하나 이상이 서로 협력해 일을 처리함.
- 프로세서는 컴퓨터 한 대 혹은 여러 대에 있을 수 있음.
- 프로세서 하나 이상이 작업을 병렬 처리하는 것으로 정의.

### 다중 프로그래밍(Multi Programming)
- 프로세서가 입출력 작업의 응답을 대기할 동안 다른 프로그램을 실행할 수 있도록 하는 것.
- 프로세서의 자원 낭비 최소화를 위해 낭비 시간을 다른 프로그램/프로세스 실행해 사용해 프로세서 하나에서 여러 프로그램을 교대로 수행하게 함.

### 다중 작업(Multi Tasking)
- 작업(하나 혹은 여러 개)이 프로세서 하나에서 운영체제의 스케줄링에 따라 조금씩 번갈아 가면서 수행하는 것.
- 조금씩 아주 빠르게 동작해 마치 동시에 동작하는 것처럼 보임.
- 다중 프로그래밍에서 나아가 정해진 시간 동안 교대로 작업을 수행.
- 메모리를 독립적으로 수행할 수 있음.
- 운영체제에서 지원하므로 서로 자원 공유가 불가능해 별도의 `IPC`(Inter-Process Communication)를 구현해 자원을 전달해야 하므로 운영체제에 상대적으로 부담이 됨.

### 다중 스레드(Multi Thread)
- 프로세스 하나에서 스레드 여러 개를 동시 실행.
- 스레드들은 공유 메모리를 가져 정보를 주고받는 데 제한이 없음.